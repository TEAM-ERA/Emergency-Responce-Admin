/* eslint-disable no-invalid-this */
/* eslint-disable no-unused-vars */
/**
 * Query Selected Report.
 */
function enterChat() {
  const msg = $('.message').val();
  const reporterID = $('.tab-content #e-case #reporterID').text();
  const adminID = $('#adminId').text();
  if ('' != msg) {
    const responderMsgBox = '<div class="chat chat-right"><div class="chat-body"></div></div>';
    $('.chat-area .chats .chats').append(responderMsgBox);
    const senderMsgBox = '<div class="chat-text"><p>' + msg + '<span class="msg-time">'+ moment(Date.now()).format('LT') +'</span></p></div>';
    $('.chat:last-child .chat-body').append(senderMsgBox);
    $('.chat-area').scrollTop($('.chat-area > .chats').height());
    $('.message').val(''),
    /*
   **Emit an event through socket.io
   ** This request is to get report details
   */
    socket.emit('sendMsg', {
      adminID: adminID,
      reporterID: reporterID,
      msg: {
        sender: adminID,
        receiver: reporterID,
        body: msg,
      },
    });
  }
}

$(document).ready(function() {
  'use strict';

  /**
   * Check is time is equal to today
   * @param {Timestamp} time Timestamp or date string
   * @return {String}
   */
  const isToday = function(time) {
    const sometime = moment(time).format('MMM Do YY');
    const today = moment().format('MMM Do YY');
    if (sometime == today) {
      return 'Today';
    } else {
      return moment(time).format('MMM D');
    }
  };

  // Listen for the load chat and execute
  socket.on('loadChat', (data)=>{
    console.log('Chat Received');
    // Clear the chat area
    $('.chat-area .chats .chats').html('');
    const reporterID = $('.tab-content #e-case #reporterID').text();
    const chatDateHTML = '<div class="chat-date-wrapper"><span class="chat-date">...</span></div>';
    // $('.chat-area .chats .chats').append(chatDateHTML);
    // render that chat messages on the frontend
    data.msgs.forEach((msg) => {
      if ($('.chat-date-wrapper span').last().text() !== isToday(msg.time) ) {
        $('.chat-area .chats .chats').append(chatDateHTML);
        $('.chat-date-wrapper span').last().text(isToday(msg.time));
      }
      if (msg.from == reporterID) {
        if ($('.chat:last-child').hasClass('chat-right')) {
          const reporterMsgBox = '<div class="chat"><div class="chat-body"></div></div>';
          $('.chat-area .chats .chats').append(reporterMsgBox);
        }
      } else {
        if ( ! $('.chat:last-child').hasClass('chat-right')) {
          const responderMsgBox = '<div class="chat chat-right"><div class="chat-body"></div></div>';
          $('.chat-area .chats .chats').append(responderMsgBox);
        }
      }
      const senderMsgBox = '<div class="chat-text"><p>' + msg.msg + '<span class="msg-time">'+ moment(msg.time).format('LT') +'<i class="small material-icons">done_all</i></span></p></div>';
      $('.chat:last-child .chat-body').append(senderMsgBox);
    });
    $('.chat-area').scrollTop($('.chat-area > .chats').height());
  });


  // A bunch of UI staff
  if (
    (900 < $(window).width() && $('#chat-sidenav').removeClass('sidenav'),
    0 < $('.sidebar-chat').length)
  ) {
    new PerfectScrollbar('.sidebar-chat', {theme: 'dark'});
  }
  if (0 < $('.chat-area').length) {
    new PerfectScrollbar('.chat-area', {theme: 'dark'});
  }
  $('.sidenav-trigger').on('click', function() {
    $(window).width() < 960 &&
      ($('.sidenav').sidenav('close'), $('.app-sidebar').sidenav('close'));
  }),
  $('#chat-sidenav').sidenav({
    onOpenStart: function() {
      $('#sidebar-list').addClass('sidebar-show');
    },
    onCloseEnd: function() {
      $('#sidebar-list').removeClass('sidebar-show');
    },
  }),
  $('.favorite i').on('click', function() {
    $(this).toggleClass('amber-text');
  }),
  $(window).width() < 900 &&
      ($('.app-chat .sidebar-left.sidebar-fixed').removeClass(
          'animate fadeUp animation-fast',
      ),
      $('.app-chat .sidebar-left.sidebar-fixed .sidebar').removeClass(
          'animate fadeUp',
      )),
  $('#chat_filter').on('keyup', function() {
    $('.chat-user').css('animation', 'none');
    const a = $(this)
        .val()
        .toLowerCase();
      '' != a ?
        ($('.sidebar-chat .chat-list .chat-user').filter(function() {
          $(this).toggle(
              -1 <
                $(this)
                    .text()
                    .toLowerCase()
                    .indexOf(a),
          );
        }),
          0 == $('.chat-user:visible').length ?
            $('.no-data-found').hasClass('show') ||
              $('.no-data-found').addClass('show') :
            $('.no-data-found').removeClass('show')) :
        $('.sidebar-chat .chat-list .chat-user').show();
  }),
  $('.chat-area').scrollTop($('.chat-area > .chats').height()),
  0 < $('html[data-textdirection=\'rtl\']').length &&
      $('#chat-sidenav').sidenav({
        edge: 'right',
        onOpenStart: function() {
          $('#sidebar-list').addClass('sidebar-show');
        },
        onCloseEnd: function() {
          $('#sidebar-list').removeClass('sidebar-show');
        },
      });
}),
$(window).on('resize', function() {
  899 < $(window).width() && $('#chat-sidenav').removeClass('sidenav'),
  $(window).width() < 900 && $('#chat-sidenav').addClass('sidenav');
});
